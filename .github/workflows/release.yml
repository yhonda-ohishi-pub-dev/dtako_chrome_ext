name: Build and Release

on:
  push:
    tags:
      - 'v*'  # v1.0, v1.1 などのタグでトリガー

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Restore .pem file from secrets
      run: |
        $pemBase64 = "${{ secrets.CHROME_EXT_PEM }}"
        $pemBytes = [System.Convert]::FromBase64String($pemBase64)
        [System.IO.File]::WriteAllBytes("dtako_chrome_ext.pem", $pemBytes)
        Write-Host ".pem file restored successfully"
      shell: powershell

    - name: Install Inno Setup
      run: |
        choco install innosetup -y

    - name: Build installer
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
      shell: powershell

    - name: Create Release and Upload Asset
      uses: softprops/action-gh-release@v1
      with:
        files: ./Output/digitaco-chrome-ext-setup-v1.0.exe
        name: Release ${{ github.ref_name }}
        body: |
          ## デジタコデータ取込補助 ${{ github.ref_name }}

          ### インストール方法
          1. 下記の `.exe` ファイルをダウンロード
          2. ダウンロードした `.exe` ファイルを実行
          3. インストーラーの指示に従う
          4. Chromeを開いて `chrome://extensions/` にアクセス
          5. 「デベロッパーモード」をONにする
          6. 「パッケージ化されていない拡張機能を読み込む」をクリック
          7. インストールフォルダ（通常 `C:\Program Files\デジタコデータ取込補助`）を選択

          ### 変更内容
          - 初回リリース
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
